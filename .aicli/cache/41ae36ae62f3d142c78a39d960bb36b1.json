{"filepath": "calculator_app.py", "mtime": 1762391436.8160257, "content": "from flask import Flask, render_template, request, jsonify, session, redirect, url_for\nimport re\nfrom functools import wraps\nfrom database import (\n    init_db, authenticate_user, has_permission, log_audit, \n    get_audit_logs, get_user_permissions, get_user_settings, update_user_settings\n)\n\nclass Calculator:\n    def __init__(self):\n        self.operators = {\n            '+': (lambda x, y: x + y, 1),\n            '-': (lambda x, y: x - y, 1),\n            '*': (lambda x, y: x * y, 2),\n            '/': (lambda x, y: x / y, 2),\n            '^': (lambda x, y: x ** y, 3),\n        }\n\n    def evaluate(self, expression):\n        # Basic validation\n        if not self.is_valid_expression(expression):\n            return \"Invalid expression\"\n\n        try:\n            # Replace ^ with ** for exponentiation\n            expression = expression.replace('^', '**')\n            \n            # Check for invalid characters\n            allowed_chars = re.compile(r'^[0-9+\\-*/().^\\s]+$')\n            if not allowed_chars.match(expression):\n                return \"Invalid characters in expression\"\n            \n            # Evaluate the expression\n            result = eval(expression, {\"__builtins__\": {}}, {})\n            \n            # Handle division by zero\n            if isinstance(result, float) and result == float('inf'):\n                return \"Division by zero\"\n            \n            return str(result)\n        except ZeroDivisionError:\n            return \"Division by zero\"\n        except Exception:\n            return \"Invalid expression\"\n\n    def is_valid_expression(self, expression):\n        # Check for balanced parentheses\n        open_parentheses = 0\n        for char in expression:\n            if char == '(': open_parentheses += 1\n            elif char == ')': open_parentheses -= 1\n            if open_parentheses < 0: return False\n        \n        # Check if parentheses are balanced\n        if open_parentheses != 0: return False\n        \n        # Check for invalid operator sequences (but allow negative numbers)\n        # Allow: +, -, *, / after operators or at start\n        # Allow: - after opening parenthesis or at start (for negative numbers)\n        # Don't allow: ++, --, **, //, +*, -*, etc. (except for negative numbers)\n        \n        # Normalize spaces\n        expression = expression.replace(' ', '')\n        \n        # Check for consecutive operators (except - for negative numbers)\n        # Pattern: operator followed by another operator (except - after opening paren or at start)\n        invalid_patterns = [\n            r'[+\\*/]{2,}',  # Multiple +, *, / not allowed\n            r'\\+\\+', r'\\*\\*', r'//',  # Specific invalid sequences\n            r'[+\\-*/]\\*[+\\-*/]',  # Operator-*-operator (except ** which is exponentiation, already replaced)\n            r'[+\\-*/]/[+\\-*/]',  # Operator-/operator\n        ]\n        \n        for pattern in invalid_patterns:\n            if re.search(pattern, expression):\n                return False\n        \n        # Allow negative numbers: - at start, - after (, - after operators\n        # But ensure it's not just a minus sign alone\n        if expression.strip() == '-':\n            return False\n        \n        return True\n\napp = Flask(__name__)\napp.secret_key = 'your-secret-key-change-in-production'  # Change this in production!\ncalculator = Calculator()\n\n# Initialize database on startup\ninit_db()\n\ndef login_required(f):\n    \"\"\"Decorator to require login\"\"\"\n    @wraps(f)\n    def decorated_function(*args, **kwargs):\n        if 'user_id' not in session:\n            return jsonify({'error': 'Authentication required'}), 401\n        return f(*args, **kwargs)\n    return decorated_function\n\ndef permission_required(permission):\n    \"\"\"Decorator to require specific permission\"\"\"\n    def decorator(f):\n        @wraps(f)\n        def decorated_function(*args, **kwargs):\n            if 'user_id' not in session:\n                return jsonify({'error': 'Authentication required'}), 401\n            if not has_permission(session['user_id'], permission):\n                return jsonify({'error': 'Permission denied'}), 403\n            return f(*args, **kwargs)\n        return decorated_function\n    return decorator\n\ndef get_client_info():\n    \"\"\"Get client IP and user agent\"\"\"\n    ip_address = request.remote_addr\n    if request.headers.get('X-Forwarded-For'):\n        ip_address = request.headers.get('X-Forwarded-For').split(',')[0]\n    user_agent = request.headers.get('User-Agent', 'Unknown')\n    return ip_address, user_agent\n\n@app.route('/')\ndef index():\n    if 'user_id' not in session:\n        return redirect(url_for('login'))\n    \n    # Get user settings for restrictions\n    settings = get_user_settings(session['user_id'])\n    return render_template('calculator.html', \n                         username=session.get('username'),\n                         allow_parentheses=settings['allow_parentheses'],\n                         allow_exponents=settings['allow_exponents'],\n                         is_admin=session.get('role_name') == 'admin')\n\n@app.route('/login', methods=['GET', 'POST'])\ndef login():\n    if request.method == 'POST':\n        data = request.get_json()\n        username = data.get('username', '')\n        password = data.get('password', '')\n        \n        user = authenticate_user(username, password)\n        if user:\n            session['user_id'] = user['id']\n            session['username'] = user['username']\n            session['role_name'] = user['role_name']\n            session['tenant_id'] = user.get('tenant_id')\n            \n            ip_address, user_agent = get_client_info()\n            log_audit(\n                user_id=user['id'],\n                username=user['username'],\n                action='login',\n                resource='authentication',\n                ip_address=ip_address,\n                user_agent=user_agent,\n                tenant_id=user.get('tenant_id')\n            )\n            \n            return jsonify({\n                'success': True,\n                'message': 'Login successful',\n                'username': user['username'],\n                'role': user['role_name']\n            })\n        else:\n            return jsonify({\n                'success': False,\n                'message': 'Invalid username or password'\n            }), 401\n    \n    return render_template('login.html')\n\n@app.route('/logout', methods=['POST'])\n@login_required\ndef logout():\n    user_id = session.get('user_id')\n    username = session.get('username')\n    \n    ip_address, user_agent = get_client_info()\n    log_audit(\n        user_id=user_id,\n        username=username,\n        action='logout',\n        resource='authentication',\n        ip_address=ip_address,\n        user_agent=user_agent\n    )\n    \n    session.clear()\n    return jsonify({'success': True, 'message': 'Logged out successfully'})\n\n@app.route('/calculate', methods=['POST'])\n@login_required\n@permission_required('calculate')\ndef calculate():\n    data = request.get_json()\n    expression = data.get('expression', '')\n    \n    if not expression:\n        return jsonify({'result': 'Empty expression', 'error': 'Empty expression'}), 400\n    \n    # Check user restrictions\n    settings = get_user_settings(session['user_id'])\n    \n    # Check for parentheses restriction\n    if not settings['allow_parentheses'] and ('(' in expression or ')' in expression):\n        log_audit(\n            user_id=session['user_id'],\n            username=session['username'],\n            action='calculate_denied',\n            resource='calculator',\n            expression=expression,\n            result='Denied: Parentheses not allowed',\n            ip_address=get_client_info()[0],\n            user_agent=get_client_info()[1]\n        )\n        return jsonify({'result': 'Error', 'error': 'Parentheses are not allowed for your account'}), 403\n    \n    # Check for exponents restriction\n    if not settings['allow_exponents'] and '^' in expression:\n        log_audit(\n            user_id=session['user_id'],\n            username=session['username'],\n            action='calculate_denied',\n            resource='calculator',\n            expression=expression,\n            result='Denied: Exponents not allowed',\n            ip_address=get_client_info()[0],\n            user_agent=get_client_info()[1]\n        )\n        return jsonify({'result': 'Error', 'error': 'Exponents are not allowed for your account'}), 403\n    \n    result = calculator.evaluate(expression)\n    \n    # Log the calculation\n    ip_address, user_agent = get_client_info()\n    log_audit(\n        user_id=session['user_id'],\n        username=session['username'],\n        action='calculate',\n        resource='calculator',\n        expression=expression,\n        result=result,\n        ip_address=ip_address,\n        user_agent=user_agent,\n        tenant_id=session.get('tenant_id')\n    )\n    \n    return jsonify({'result': result})\n\n@app.route('/history', methods=['GET'])\n@login_required\n@permission_required('view_history')\ndef history():\n    \"\"\"Get calculation history for the current user\"\"\"\n    user_id = session['user_id']\n    logs = get_audit_logs(user_id=user_id, limit=50)\n    \n    # Filter to only calculation actions\n    calculations = [\n        {\n            'expression': log['expression'],\n            'result': log['result'],\n            'timestamp': log['timestamp']\n        }\n        for log in logs if log['action'] == 'calculate'\n    ]\n    \n    return jsonify({'calculations': calculations})\n\n@app.route('/audit', methods=['GET'])\n@login_required\n@permission_required('view_audit')\ndef audit():\n    \"\"\"Get audit logs (admin only) - multitenancy: only shows logs for users in admin's tenancy\"\"\"\n    limit = request.args.get('limit', 100, type=int)\n    user_id_filter = request.args.get('user_id', type=int)\n    tenant_id = session.get('tenant_id')\n    \n    # Multitenancy: Admin can only see logs for users in their tenant\n    if user_id_filter:\n        # Filter by specific user (must be in same tenant)\n        logs = get_audit_logs(user_id=user_id_filter, tenant_id=tenant_id, limit=limit)\n    else:\n        # Get all logs for admin's tenant only\n        logs = get_audit_logs(tenant_id=tenant_id, limit=limit)\n    \n    return jsonify({'logs': logs})\n\n@app.route('/audit/users', methods=['GET'])\n@login_required\n@permission_required('view_audit')\ndef audit_users():\n    \"\"\"Get list of users for audit log filtering (admin only) - multitenancy: only users in admin's tenant\"\"\"\n    from database import get_db\n    tenant_id = session.get('tenant_id')\n    with get_db() as conn:\n        cursor = conn.cursor()\n        # Multitenancy: Only show users in the same tenant\n        cursor.execute('''\n            SELECT DISTINCT u.id, u.username, COUNT(al.id) as log_count\n            FROM users u\n            LEFT JOIN audit_logs al ON u.id = al.user_id AND al.tenant_id = ?\n            WHERE u.tenant_id = ?\n            GROUP BY u.id, u.username\n            ORDER BY u.username\n        ''', (tenant_id, tenant_id))\n        users = [dict(row) for row in cursor.fetchall()]\n        return jsonify({'users': users})\n\n@app.route('/user/info', methods=['GET'])\n@login_required\ndef user_info():\n    \"\"\"Get current user information\"\"\"\n    permissions = get_user_permissions(session['user_id'])\n    return jsonify({\n        'username': session.get('username'),\n        'role': session.get('role_name'),\n        'permissions': permissions\n    })\n\n@app.route('/check-auth', methods=['GET'])\ndef check_auth():\n    \"\"\"Check if user is authenticated\"\"\"\n    if 'user_id' in session:\n        settings = get_user_settings(session['user_id'])\n        return jsonify({\n            'authenticated': True,\n            'username': session.get('username'),\n            'role': session.get('role_name'),\n            'settings': settings\n        })\n    return jsonify({'authenticated': False}), 401\n\n@app.route('/admin/user-settings', methods=['GET'])\n@login_required\n@permission_required('manage_users')\ndef get_all_user_settings():\n    \"\"\"Get all user settings (admin only)\"\"\"\n    from database import get_db\n    with get_db() as conn:\n        cursor = conn.cursor()\n        cursor.execute('''\n            SELECT u.id, u.username, \n                   COALESCE(us.allow_parentheses, 1) as allow_parentheses,\n                   COALESCE(us.allow_exponents, 1) as allow_exponents\n            FROM users u\n            LEFT JOIN user_settings us ON u.id = us.user_id\n            ORDER BY u.username\n        ''')\n        users = [dict(row) for row in cursor.fetchall()]\n        return jsonify({'users': users})\n\n@app.route('/admin/user-settings/<int:target_user_id>', methods=['PUT'])\n@login_required\n@permission_required('manage_users')\ndef update_target_user_settings(target_user_id):\n    \"\"\"Update user settings for a specific user (admin only)\"\"\"\n    data = request.get_json()\n    allow_parentheses = data.get('allow_parentheses')\n    allow_exponents = data.get('allow_exponents')\n    \n    update_user_settings(target_user_id, allow_parentheses, allow_exponents)\n    \n    # Log the change\n    ip_address, user_agent = get_client_info()\n    log_audit(\n        user_id=session['user_id'],\n        username=session['username'],\n        action='update_user_settings',\n        resource='admin',\n        expression=f'Updated settings for user_id {target_user_id}',\n        result=f'Parentheses: {allow_parentheses}, Exponents: {allow_exponents}',\n        ip_address=ip_address,\n        user_agent=user_agent\n    )\n    \n    return jsonify({'success': True, 'message': 'Settings updated'})\n\nif __name__ == '__main__':\n    app.run(host='0.0.0.0', port=2000, debug=False)", "timestamp": 1762403510.973202}